<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../firebase-element/firebase-element.html">
<link rel="import" href="../../marked-element/marked-element.html">
<link rel="import" href="../../pvc-globals/pvc-globals.html">

<link rel="import" href="speakur-post.html">
<link rel="import" href="speakur-author-slug.html">

<polymer-element name="speakur-compose" attributes="firebaseLocation threadId replyTo">
    <template>
        <style>
            .cancel-btn {
                margin-right: 10px;
            }

            .preview-div {
                margin-top: 12px;
            }

            .posting-as {
                margin-right: 16px;
                font-size: 90%;
            }
        </style>
        <link rel="stylesheet" href="../../bootstrap/dist/css/bootstrap.min.css">
        <firebase-element
                id="posts" data="{{posts}}"
                location="{{postLocation(firebaseLocation, replyTo)}}"></firebase-element>
        <pvc-globals namespace="speakur-discussion" values="{{globals}}"></pvc-globals>

        <form>
            <div class="body">
                <div class="form-group">
                    <label class="sr-only" for="commentText">Leave a comment:</label>
                        <textarea
                                value="{{newText}}"
                                rows="3"
                                class="form-control"
                                placeholder="Leave a comment here."
                                id="commentText"></textarea>
                    <!--
                                        <mark-down-editor
                                                    rows="3"
                                                    class="form-control"
                                                    placeholder="Enter a comment here."
                                                    id="commentText">

                                            </mark-down-editor>
                    -->
                </div>
            </div>
            <div class="footer">
                <template if="{{newText.length}}">
                    <div horizontal layout center>
                        <div style="margin-left: 12px;" on-click="{{editingHelp}}">
                            Editing Help
                        </div>
                        <div flex></div>
                        <div horizontal layout end-justified center  class="posting-as">
                            <span style="margin-right: 4px;">
                                Posting as:
                            </span>
                            <speakur-author-slug author="{{globals.profile}}"></speakur-author-slug>
                        </div>
                        <div
                                on-click="{{cancel}}"
                                title="Cancel (Clear Text)"
                                class="btn btn-sm btn-danger cancel-btn">
                            Cancel
                        </div>
                        <div on-click="{{submit}}" title="Publish Comment" class="btn btn-sm btn-primary">Publish
                            Comment
                        </div>
                    </div>
                    <div class="preview-div">
                        <speakur-post
                                id="preview"
                                previewText="{{newText}}"
                                previewing="{{true}}">
                        </speakur-post>
                    </div>
                </template>
            </div>
        </form>
    </template>
    <script>
        Polymer({
            newText: '',

            postLocation: function (firebaseLocation, replyTo) {
                // {{firebaseLocation}}/posts/{{replyTo}}
                if (!firebaseLocation) { return ''; }
                if (!replyTo) { return ''; }
                return firebaseLocation + "/posts/" + replyTo;
            },

            submit: function () {
                if (!this.threadId) {
                    console.error("Unable to submit post; no threadId given");
                    return false;
                }
                if (!this.newText.length) {
                    console.error('Please write something.');
                    // TODO: error handling - toast?
                    return false;
                }

                var author;
                if (this.globals.profile) {
                    author = {
                        uid: this.globals.profile.uid,
                        username: this.globals.profile.username,
                        picture_link: this.globals.profile.picture_link,
                        md5_hash: this.globals.profile.md5_hash
                    };
                } else {
                    author = _.clone(this.globals.anon_author, true);
                }

                // insert own upvote?
                var post = {
                    threadId: this.threadId,
                    replyTo: this.replyTo,
                    // replies: [],
                    upvotes: 0,
                    downvotes: 0,
                    text: this.newText,
                    author: author,
                    timestamp: new Date().getTime()
                };
                var postRef = this.$.posts.push(post);
                var post_id = postRef.key();
                console.log("Created post: " + post_id);

                this.newText = '';
                post['postId'] = post_id;

                this.fire('submitted-post', post);
            },

            cancel: function () {
                if (!this.newText.length) {
                    console.error("Nothing in the compose box.");
                    return false;
                }
                this.fire('cancel-post');

                // TODO: might want to just hide it, not delete the text.
                this.newText = '';

            },

            editingHelp: function() {
                this.fire('not-yet-implemented');
            }
        });
    </script>
</polymer-element>
