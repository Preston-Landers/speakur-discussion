<!--
Copyright (c) 2015 Preston Landers. All rights reserved.
This code may only be used under the BSD style license found at http://speakur.github.io/LICENSE.txt
The complete set of authors may be found at http://speakur.github.io/AUTHORS.txt
The complete set of contributors may be found at http://speakur.github.io/CONTRIBUTORS.txt
-->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../firebase-element/firebase-element.html">
<link rel="import" href="../../marked-element/marked-element.html">
<link rel="import" href="../../pvc-globals/pvc-globals.html">

<link rel="import" href="../imports/bootstrap.partial.html">
<link rel="import" href="speakur-post.html">
<link rel="import" href="speakur-author-slug.html">

<polymer-element
    name="speakur-compose"
    extends="speakur-base"
    attributes="firebaseLocation threadId replyTo editing">
    <template>
        <core-style ref="bootstrap-form"></core-style>

        <style>
            .tool-btn {
                margin-left: 10px;
            }

            .preview-div {
                margin-top: 12px;
            }

            .posting-as {
                margin-right: 6px;
                font-size: 90%;
                font-weight: bold;
            }
        </style>
        <firebase-element
            id="posts" data="{{posts}}"
            location="{{ fbLocation(firebaseLocation, 'posts', replyTo) }}"></firebase-element>
        <firebase-element
            id="dbEditPost" data="{{editPost}}"
            location="{{ fbLocation(firebaseLocation, 'posts', replyTo, editing) }}"></firebase-element>
        <pvc-globals namespace="speakur-discussion" values="{{globals}}"></pvc-globals>

        <form>
            <div class="body">
                <div class="form-group">
                    <label class="sr-only" for="commentText">
                        {{ 'leave_comment' | $$(lc) }}
                    </label>
                        <!--value="{{newText}}"-->
                        <textarea
                            rows="3"
                            class="form-control"
                            placeholder="{{ 'leave_comment_placeholder' | $$(lc) }}"
                            id="commentText"></textarea>
                </div>
            </div>
            <div class="footer">
                <template if="{{newText.length}}">
                    <div horizontal layout center>
                        <div style="margin-left: 12px;" on-click="{{editingHelp}}">
                            {{ 'Editing Help' | $$(lc) }}
                        </div>
                        <div flex></div>
                        <div horizontal layout end-justified center class="posting-as">
                            <span style="margin-right: 4px;">
                                {{ 'posting_as' | $$(lc) }}
                            </span>
                            <speakur-author-slug author="{{globals.profile}}"></speakur-author-slug>
                        </div>
                        <div
                            on-click="{{resetEditText}}"
                            title="{{ 'undo_changes_title' | $$(lc) }}"
                            hidden?="{{ !editing }}"
                            class="btn btn-sm btn-warning reset-btn tool-btn">
                            {{ 'Undo Changes' | $$(lc) }}
                        </div>
                        <div
                            on-click="{{cancel}}"
                            title="{{ 'Cancel' | $$(lc) }} ({{ cancelTitle(lc) }})"
                            class="btn btn-sm btn-danger cancel-btn tool-btn">
                            {{ 'Cancel' | $$(lc) }}
                        </div>
                        <template if="{{ !editing }}">
                            <div on-click="{{submit}}" title="{{ 'publish_comment_title' | $$(lc) }}"
                                 class="btn btn-sm btn-primary tool-btn">
                                {{ 'Publish Comment' | $$(lc) }}
                            </div>
                        </template>
                        <template if="{{ editing }}">
                            <div on-click="{{saveEdit}}" title="{{ 'Save Changes' | $$(lc) }}"
                                 class="btn btn-sm btn-primary tool-btn">
                                {{ 'Save Changes' | $$(lc) }}
                            </div>
                        </template>
                    </div>
                    <div class="preview-div">
                        <speakur-post
                            id="preview"
                            previewText="{{previewText}}"
                            previewingEdit="{{editing}}"
                            previewing="true">
                        </speakur-post>
                    </div>
                </template>
            </div>
        </form>
    </template>
    <script>
        Polymer({
            // current text editing buffer
            newText: '',

            // periodically update preview buffer - a 'live' update is very, very slow...
            previewText: '',

            // original post text before editing (if any)
            originalEditText: null,

            ready: function () {
                _.merge(this.computed, this.base_computed);  // TODO: see comment in speakur-base
            },

            cancelTitle: function(lc) {
                if (this.topLevelComment) return this.$$('Clear Text', lc);
                return this.$$('Hide Text', lc);
            },

            domReady: function () {
                // this.updatePreviewText();
                var that = this;
                var commentText = jQuery(this.$.commentText);
                // var oldVal = '';

                // Using a regular Polymer value binding on a textarea seems to produce
                // extremely slow performance as polymer goes nuts observing its changes
                // Doing it this way seems a lot faster...
                commentText.on("keyup", function () {
                    var currVal = commentText.val();
                    that.newText = currVal;

                    // rate-limit these updates to preview for performance...
                    that.job('update-preview-text', function () {
                        that.previewText = currVal;
                    }, 500);

                });
            },


            // when post we're editing has changed, reset the saved original text
            editPostChanged: function () {
                if (this.editing) {
                    // If editing, load the current text into the editing buffer.
                    this.originalEditText = this.posts[this.editing].text;
                    this.resetEditText();
                }
            },

            // restore the original text
            resetEditText: function () {
                if (this.originalEditText) {
                    this.setNewText(this.originalEditText);
                }
            },

            // Save changes to the post.
            saveEdit: function () {

                var editingPost = this.editPost;
                var oldText = {
                    text: editingPost.text
                };
                if (editingPost.lastModified) {
                    oldText.timestamp = editingPost.lastModified;
                } else if (editingPost.timestamp) {
                    oldText.timestamp = editingPost.timestamp;
                }
                if (!editingPost.oldTextList) {
                    editingPost.oldTextList = [];
                }
                var author = this.getAuthor();

                editingPost.oldTextList.push(oldText);
                editingPost.oldTextList = this.maybeTrimOldPostVersions(editingPost.oldTextList);

                editingPost.text = this.newText;
                editingPost.lastModified = new Date().getTime();

                // rewrite the author record w/ current vals but only if we're the original author
                // ie. not an admin/moderator
                if (editingPost.author.uid === author.uid) {
                    editingPost.author = author;
                }

                // this.log("Save EDIT");

                // write it
                this.posts[this.editing] = editingPost;

                this.toast(this.$$('changes_saved'));
                this.fire('submitted-edit', editingPost);
            },

            maybeTrimOldPostVersions: function (oldTextList) {
                if (oldTextList.length > this.globals.maxPostRevisionsKeep) {
                    //
                    var killnum = oldTextList.length - this.globals.maxPostRevisionsKeep;
                    this.log("Getting rid of " + killnum + " old versions!");
                    return _.slice(oldTextList, killnum-1);
                }
                return oldTextList;
            },

            submit: function () {
                if (!this.threadId) {
                    this.errorToast("Internal error: no threadId available.");
                    return false;
                }
                if (!this.newText.length) {
                    this.errorToast(this.$$('pls_write_something'));
                    return false;
                }

                var author = this.getAuthor();

                // insert own upvote?
                var post = {
                    threadId: this.threadId,
                    replyTo: this.replyTo,
                    // replies: [],
                    text: this.newText,
                    author: author,
                    timestamp: new Date().getTime()
                };
                var postRef = this.$.posts.push(post);
                var post_id = postRef.key();
                this.log("Created post: " + post_id);

                this.setNewText();
                post['postId'] = post_id;

                this.toast(this.$$('post_saved'));
                this.fire('submitted-post', post);
            },

            getAuthor: function () {
                var author;
                if (this.globals.profile) {
                    author = {
                        uid: this.globals.profile.uid,
                        username: this.globals.profile.username,
                        picture_link: this.globals.profile.picture_link,
                        md5_hash: this.globals.profile.md5_hash
                    };
                } else {
                    author = _.clone(this.globals.anon_author, true);
                }
                return author;
            },

            cancel: function () {
                if (!this.newText.length) {
                    // this.errorToast("There is nothing to cancel.");
                    return false;
                }
                if (this.editing) {
                    this.fire('cancel-edit');
                } else {
                    this.fire('cancel-post');
                }

                if (this.threadId == this.replyTo) {
                    this.log("canceled top level post");
                    this.setNewText();
                }

                //// this would delete the text...
                // this.newText = '';

            },

            editingHelp: function () {
                this.fire('not-yet-implemented');
            },


            // reset the textarea to either the given value or blank
            setNewText: function (val) {
                if (!val) val = '';
                this.newText = val;
                jQuery(this.$.commentText).val(val);
            },

            computed: {
                topLevelComment: "threadId == replyTo",
                "lc": "globals.currentLocale ? globals.currentLocale : 'en'",
                "anon_name": "'Anonymous' | $$(globals.currentLocale ? globals.currentLocale : 'en')"
            }
        });
    </script>
</polymer-element>
