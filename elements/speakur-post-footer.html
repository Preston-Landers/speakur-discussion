<!--
Copyright (c) 2015 Preston Landers. All rights reserved.
This code may only be used under the BSD style license found at http://speakur.github.io/LICENSE.txt
The complete set of authors may be found at http://speakur.github.io/AUTHORS.txt
The complete set of contributors may be found at http://speakur.github.io/CONTRIBUTORS.txt
-->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../core-icon/core-icon.html">
<link rel="import" href="../../pvc-globals/pvc-globals.html">

<!--
    Present a UI for the post display footer with actions like vote, edit, delete, etc.
  -->
<polymer-element
    name="speakur-post-footer"
    extends="speakur-base"
    attributes="post postVotes voteElem">
    <template>
        <style>
            .speakur-post-toolbar > div {
                margin-right: 10px;
            }

            .speakur-post-toolbar > .report-post-button {
                margin-right: 0;
            }

            .vote-block {
                margin-right: 8px;
            }

            .vote {
                width: 16px;
                height: 14px;
                opacity: 0.3;
            }

            .vote-down-block {
                margin-right: 6px;
                color: #800004;
                display: inline;
            }

            /* actually has voted down */
            .voted-down {
                color: #d40005;
                opacity: 1.0;
            }

            .vote-up-block {
                margin-left: 6px;
                color: #000ec1;
                display: inline;
            }

            /* actually has voted up */
            .voted-up {
                color: #0011fd;
                opacity: 1.0;
            }

            .not-voted {
                opacity: 0.2;
            }
        </style>
        <pvc-globals namespace="speakur-discussion" values="{{globals}}"></pvc-globals>
        <template if="{{ ! post.deleted }}">
            <div horizontal center layout class="speakur-post-toolbar">
                <span class="vote-block">
                    <div class="vote-up-block">
                        <core-icon
                            title="Adds to discussion"
                            id="voteUp"
                            class="vote vote-up {{ {'not-voted': notVoted, 'voted-up': votedUp} | tokenList }}  "
                            on-click="{{voteUp}}"
                            icon="thumb-up"></core-icon>
                        ({{numUpvotes}})
                    </div>
                    &vert;
                    <div class="vote-down-block">
                        <core-icon
                            title="Not a 'Disagree' button!"
                            id="voteDown"
                            class="vote vote-down {{ {'not-voted': notVoted, 'voted-down': votedDown} | tokenList }} "
                            on-click="{{voteDown}}"
                            icon="thumb-down"></core-icon>

                        ({{numDownvotes}})
                    </div>
                </span>

                <div title="Reply to comment" on-click="{{replyToPost}}">
                    Reply
                </div>

                <template if="{{canEditPost(post, globals.profile, globals.isAdmin)}}">
                    <div title="Edit this comment." on-click="{{editPost}}">
                        Edit
                    </div>
                </template>

                <template if="{{canDeletePost(post, globals.profile, globals.isAdmin)}}">
                    <div title="Permanently delete this comment." on-click="{{deletePost}}">
                        Delete
                    </div>
                </template>

                <div flex></div>
                <div class="report-post-button" title="Report spam, harassment or illegal content."
                     on-click="{{reportPost}}">
                    Report
                </div>
            </div>
        </template>
    </template>
    <script>
        Polymer({
            getNetVotes: function (postVotes) {
                return this.numUpvotes(postVotes) - this.numDownvotes(postVotes);
            },

            getNumUpvotes: function (postVotes) {
                if (!postVotes) return 0;
                return postVotes.up || 0;
            },

            getNumDownvotes: function (postVotes) {
                if (!postVotes) return 0;
                return postVotes.down || 0;
            },

            computed: {
                // netVotes: "getNetVotes(postVotes, voteElem.votedUp, voteElem.votedDown)",
                numUpvotes: "getNumUpvotes(postVotes, voteElem.votedUp, voteElem.votedDown)",
                numDownvotes: "getNumDownvotes(postVotes, voteElem.votedUp, voteElem.votedDown)",
                votedUp: "globals.profile && voteElem && voteElem.votedUp ? true: false",
                votedDown: "globals.profile && voteElem && voteElem.votedDown ? true: false",
                notVoted: "!globals.profile || !voteElem || (!voteElem.votedDown && !voteElem.votedUp) ? true: false"
            },

            canDeletePost: function (post, my_profile, isAdmin) {
                if (isAdmin) {
                    return true;
                }
                if (!my_profile || !post || !post.author || !post.author.uid) {
                    return false;
                }
                if (post.author.uid === "anonymous" ||
                    post.author.uid === "anon") {
                    // Only admin can delete anon posts - later add moderators
                    return false;
                }
                return post.author.uid === my_profile.uid;
            },

            canEditPost: function (post, my_profile, isAdmin) {
                return this.canDeletePost(post, my_profile, isAdmin);
            },

            replyToPost: function () {
                this.fire('reply-to-post', this.post);
            },
            editPost: function () {
                this.fire('edit-post', this.post);
            },
            reportPost: function () {
                this.fire('report-post', this.post);
            },
            deletePost: function () {
                this.fire('delete-post', this.post);
            },
            voteUp: function () {
                this.fire('vote-up', this.post);
            },
            voteDown: function () {
                this.fire('vote-down', this.post);
            }
        });
    </script>
</polymer-element>
