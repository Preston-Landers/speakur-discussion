<!--
Copyright (c) 2015 Preston Landers. All rights reserved.
This code may only be used under the BSD style license found at http://speakur.github.io/LICENSE.txt
The complete set of authors may be found at http://speakur.github.io/AUTHORS.txt
The complete set of contributors may be found at http://speakur.github.io/CONTRIBUTORS.txt
-->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../core-icon/core-icon.html">
<link rel="import" href="../../pvc-globals/pvc-globals.html">

<polymer-element
    name="speakur-post-footer"
    extends="speakur-base"
    attributes="post">
    <template>
        <style>
            .speakur-post-toolbar > div {
                margin-right: 10px;
            }

            .speakur-post-toolbar > .report-post-button {
                margin-right: 0;
            }

            .vote-block {
                margin-right: 8px;
            }

            .vote {
                width: 16px;
                height: 14px;
            }

            .vote-down {
                margin-right: 6px;
                color: #800004;
            }

            .vote-up {
                margin-left: 6px;
                color: #000ec1;
            }

            .not-voted {
                opacity: 0.2;
            }
        </style>
        <pvc-globals namespace="speakur-discussion" values="{{globals}}"></pvc-globals>
        <template if="{{ ! post.deleted }}">
            <div horizontal center layout class="speakur-post-toolbar">
                <span class="vote-block">
                    <template if="{{netVotes !== 0}}">
                        {{netVotes}}
                    </template>
                    <core-icon
                        title="Good contribution"
                        id="voteUp"
                        class="vote vote-up not-voted"
                        on-click="{{voteUp}}"
                        icon="thumb-up"></core-icon>
                    &vert;
                    <core-icon
                        title="It stinks!"
                        id="voteDown"
                        class="vote vote-down not-voted"
                        on-click="{{voteDown}}"
                        icon="thumb-down"></core-icon>
                </span>

                <div title="Reply to comment" on-click="{{replyToPost}}">
                    Reply
                </div>

                <template if="{{canEditPost(post, globals.profile, globals.isAdmin)}}">
                    <div title="Edit this comment." on-click="{{editPost}}">
                        Edit
                    </div>
                </template>

                <template if="{{canDeletePost(post, globals.profile, globals.isAdmin)}}">
                    <div title="Permanently delete this comment." on-click="{{deletePost}}">
                        Delete
                    </div>
                </template>

                <div flex></div>
                <div class="report-post-button" title="Report spam, harassment or illegal content." on-click="{{reportPost}}">
                    Report
                </div>
            </div>
        </template>
    </template>
    <script>
        Polymer({
            getNetVotes: function (post) {
                if (!post) {
                    return 0;
                }
                // if we have auto-own-upvote, should we reflect a 1 vote post as 'neutral' ? instead of 0
                if (!Object.keys(post).length) {
                    return 0;
                }
                var upvotes = post.upvotes || 0;
                var downvotes = post.downvotes || 0;
                return upvotes - downvotes;
            },
            computed: {
                netVotes: "getNetVotes(post)"
            },
            canDeletePost: function (post, my_profile, isAdmin) {
                if (isAdmin) { return true; }
                if (!my_profile || !post || !post.author || !post.author.uid) {
                    return false;
                }
                if (post.author.uid === "anonymous" ||
                    post.author.uid === "anon") {
                    // Only admin can delete anon posts - later add moderators
                    return false;
                }
                return post.author.uid === my_profile.uid;
            },

            canEditPost: function (post, my_profile, isAdmin) {
                return this.canDeletePost(post, my_profile, isAdmin);
            },

            replyToPost: function () {
                this.fire('reply-to-post', this.post);
            },
            editPost: function () {
                this.fire('edit-post', this.post);
            },
            reportPost: function () {
                this.fire('report-post', this.post);
            },
            deletePost: function () {
                this.fire('delete-post', this.post);
            },
            voteUp: function () {
                this.fire('vote-up', this.post);

                // Up/Down vote should be separate toggles.

                jQuery(this.$.voteUp).toggleClass("not-voted");
                // var $vdown = jQuery(this.$.voteDown);
                // if ($vdown.hasClass('not-voted'))
                // jQuery(this.$.voteDown).addClass("not-voted");
            },
            voteDown: function () {
                this.fire('vote-down', this.post);
                jQuery(this.$.voteDown).toggleClass("not-voted");
                //jQuery(this.$.voteUp).addClass("not-voted");
            }
        });
    </script>
</polymer-element>
