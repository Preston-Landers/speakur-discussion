<!--
Copyright (c) 2015 Preston Landers. All rights reserved.
This code may only be used under the BSD style license found at http://speakur.github.io/LICENSE.txt
The complete set of authors may be found at http://speakur.github.io/AUTHORS.txt
The complete set of contributors may be found at http://speakur.github.io/CONTRIBUTORS.txt
-->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../pvc-globals/pvc-globals.html">
<link rel="import" href="../../firebase-element/firebase-element.html">
<polymer-element
    name="speakur-profile"
    extends="speakur-base"
    attributes="firebaseLocation uid profile">
    <template>
        <!--
          This location expression is really ugly ... there has to be a way to fix this.
          Really this is just to avoid attempting to access just "/profile/" before the site or UID are defined.
          I'm probably misunderstand something here.
        -->
        <firebase-element id="base" location="{{profileLocation(firebaseLocation,uid)}}"
                          data="{{profile}}"></firebase-element>
        <firebase-element id="admins" location="{{adminsLocation(firebaseLocation,uid)}}"
                          data="{{admins}}"></firebase-element>
        <pvc-globals namespace="speakur-discussion" values="{{globals}}"></pvc-globals>
    </template>
    <script>
        (function () {

            Polymer({
                ready: function () {
                },
                attached: function () {
                    var that = this;
                    this.ownerDocument.addEventListener('speakur-user-logout', function (e) {
                        that.doLogout(e);
                    });
                    this.ownerDocument.addEventListener('speakur-user-login', function (e) {
                        that.reactToLogin(e);
                    });

                },

                profileLocation: function (firebaseLocation, uid) {
                    if (!firebaseLocation) { return ''; }
                    if (!uid) { return ''; }
                    return firebaseLocation + "/profile/" + uid;
                },

                adminsLocation: function (firebaseLocation, uid) {
                    if (!firebaseLocation) { return ''; }
                    if (!uid) { return ''; }
                    return firebaseLocation + "/admins/" + uid;
                },

                reactToLogin: function (e) {
                    this.log("profile notified that user logged in.");
                },

                doLogout: function (e) {
                    this.log("doLogout in speakur-profile");
                    // clear out the global user/profile info
                    this.uid = null;
                    this.globals.currentUser = null;
                    this.globals.profile = null;
                    this.globals.isAdmin = false;
                },

                profileChanged: function () {
                    var user = this.globals.currentUser;
                    if (!user) {
                        return;
                    }
                    // this.log("Checking user profile of: ", user.uid, " at location ", this.$.base.location);
                    if (!this.profile) {
                        this.log("Creating profile for " + user.uid);
                        this.profile = this.createProfile(user);
                    }
                    else {
                        this.log("Profile already exists: ", this.profile, ". Updating it.");
                        this.updateProfileFromProvider(user, this.profile);
                    }
                    // this.log("firebase profile: ", this.profile);
                    this.globals.profile = this.profile;

                    // TODO: whether or not the user is an admin is indeterminate at this point
                    // until adminsChanged is called;
                },

                adminsChanged: function () {
                    this.log("admins changed: ", this.admins);
                    if (this.admins) {
                        this.log("Congrats, you are an admin.");
                        this.globals.isAdmin = true;
                    } else {
                        this.log("You're a regular old user.");
                        this.globals.isAdmin = false;
                    }
                },

                updateProfileFromProvider: function(puser, profile) {
                    /// Update everything that we care about updating EVERY time, not just first time.

                    // Update image and email address from current values
                    // possibly locale?


                    var email, xprof, displayName;

                    if (puser.google) {
                        xprof = puser.google.cachedUserProfile;
                        displayName = user.google.displayName;
                        email = puser.google.email;
                        profile['fullname'] = displayName;
                        if (xprof) {
                            // doesn't provide TZ... could get from browser?
                            profile['picture_link'] = xprof.picture;
                            // profile['about_link'] = xprof.link;
                            // profile['locale'] = xprof.locale;
                        }
                    } else if (puser.facebook) {
                        xprof = puser.facebook.cachedUserProfile;
                        displayName = puser.facebook.displayName;
                        email = puser.facebook.email;
                        profile['fullname'] = displayName;
                        if (xprof) {
                            // profile['timezone'] = xprof.timezone;
                            profile['picture_link'] = xprof.picture.data.url;
                            // profile['about_link'] = xprof.link;
                            // profile['locale'] = xprof.locale;
                        }
                    }

                    if (email) {
                        this.setEmailAddress(profile, email);
                    } else {
                        this.log("Warning: user " + puser.uid + " hasn't provided an email address.");
                    }

                },

                setEmailAddress: function (profile, email) {
                    if (email) {
                        profile['email'] = email;
                        profile['md5_hash'] = md5(email);
                    }
                },


                firstTimeProfileInfoFromProvider: function (puser, profile) {
                    // Add stuff that we only care about the first time, in theory b/c we will manage it
                    var xprof, displayName;
                    if (puser.google) {
                        xprof = puser.google.cachedUserProfile;
                        displayName = puser.google.displayName;
                        profile['username'] = displayName;
                        if (xprof) {
                            // doesn't provide TZ... could get from browser?
                            profile['about_link'] = xprof.link;
                            profile['locale'] = xprof.locale;
                        }
                    } else if (puser.facebook) {
                        xprof = puser.facebook.cachedUserProfile;
                        displayName = puser.facebook.displayName;
                        profile['username'] = displayName;
                        if (xprof) {
                            profile['timezone'] = xprof.timezone;
                            profile['about_link'] = xprof.link;
                            profile['locale'] = xprof.locale;
                        }
                    }
                },


                // create a new generic user profile from an authentication user
                createProfile: function (user) {

                    var prof = {
                        uid: user.uid,
                        provider: user.provider,
                        username: '',
                        email: '',
                        picture_link: '',
                        about_link: '',
                        about: '',
                        locale: 'en',
                        fullname: '',
                        md5_hash: '',
                        timezone: -5
                    };

                    this.updateProfileFromProvider(user, prof);

                    this.firstTimeProfileInfoFromProvider(user, prof);

                    return prof;
                }

            });
        })();
    </script>
</polymer-element>
