<!--
Copyright (c) 2015 Preston Landers. All rights reserved.
This code may only be used under the BSD style license found at http://speakur.github.io/LICENSE.txt
The complete set of authors may be found at http://speakur.github.io/AUTHORS.txt
The complete set of contributors may be found at http://speakur.github.io/CONTRIBUTORS.txt
-->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../firebase-element/firebase-element.html">
<link rel="import" href="../../marked-element/marked-element.html">
<link rel="import" href="../../highlightjs-element/highlightjs-element.html">
<link rel="import" href="../../pvc-globals/pvc-globals.html">
<link rel="import" href="../../core-collapse/core-collapse.html">

<link rel="import" href="speakur-author-img.html">
<link rel="import" href="speakur-author-slug.html">
<link rel="import" href="speakur-card.html">
<link rel="import" href="speakur-post-footer.html">
<link rel="import" href="speakur-post-set.html">
<link rel="import" href="speakur-post-vote.html">
<link rel="import" href="speakur-compose.html">

<polymer-element
    name="speakur-post"
    extends="speakur-base"
    attributes="firebaseLocation threadId parentId postId previewing previewText previewingEdit level sortOrder">
    <template>
        <link rel="stylesheet" href="../../highlightjs/styles/default.css">
        <style>
            .post-card-container {
                margin: 0 0 10px;
            }

            /* give less padding to the body of the card within. maybe just change the card itself */
            speakur-card /deep/ .card-body {
                padding-top: 0;
                padding-bottom: 0;
            }

            .post-author-img {
                /*padding: 10px 10px 10px 0;*/
                /*padding: 2px 2px 2px 0;*/
                padding: 0;
                margin: 0;
            }

            speakur-card > .header /deep/ .username {
                margin-right: 12px;
                font-weight: bold;
                text-shadow: 1px 1px rgba(20, 20, 22, 0.78);
            }

            speakur-card /deep/ .deleted-post-body {
                padding-top: 14px;
                padding-bottom: 12px;
            }

        </style>
        <pvc-globals namespace="speakur-discussion" values="{{globals}}"></pvc-globals>
        <speakur-post-vote
            id="vote"
            uid="{{globals.currentUser.uid}}"
            postVotes="{{postVotes}}"
            parentId="{{parentId}}"
            postId="{{postId}}"
            firebaseLocation="{{firebaseLocation}}"></speakur-post-vote>
        <template if="{{!previewing}}">
            <firebase-element
                id="postDB" data="{{post}}"
                location="{{fbLocation(firebaseLocation, 'posts', parentId, postId) }}"></firebase-element>
            <firebase-element
                id="postvotesDB" data="{{postVotes}}"
                location="{{fbLocation(firebaseLocation, 'postvotes', parentId, postId) }}"></firebase-element>

        </template>
        <template if="{{!previewing || previewText}}">
            <div layout horizontal class="post-container">

                <div class="mmwidth" _style="min-width: {{indentWidth}}px;">
                    <core-collapse opened id="imgCollapse">
                        <div class="post-author-img">
                            <speakur-author-img
                                width="42" height="42"
                                author="{{previewing ? globals.profile : post.author}}">
                            </speakur-author-img>
                        </div>
                    </core-collapse>
                </div>
                <div flex class="post-card-container">
                    <speakur-card id="card" collapsible="true" curved="true">
                        <style>

                            .edited-time {
                                margin-left: 6px;
                                font-size: 0.9em;
                                font-style: italic;
                            }

                            .post-time {
                                font-size: 0.9em;
                                font-style: italic;
                            }

                            .netVotesTitleDisplay {
                                font-size: 0.8em;
                                margin-right: 8px;
                            }

                        </style>
                        <div layout horizontal center class="header">
                            <template if="{{ previewing && previewingEdit}}">
                                Preview - Edit Post
                            </template>
                            <template if="{{previewing && ! previewingEdit }}">
                                Preview
                            </template>
                            <template if="{{ !previewing }}">
                                <speakur-author-slug showPicture="false" author="{{post.author}}"></speakur-author-slug>
                                <div class="netVotesTitleDisplay">
                                    {{netVotesText}}
                                </div>
                                <div class="post-time" title="{{post.timestamp | formatTimestamp}}">
                                    <time>
                                        {{globals.updateTick && post.timestamp | formatTimestampFromAgo}}
                                    </time>
                                </div>
                                <template if="{{ post.lastModified && post.lastModified !== post.timestamp }}">
                                    <div class="edited-time" title="{{post.lastModified | formatTimestamp}}">
                                        &mdash;
                                        Edited:
                                        <time>
                                            {{globals.updateTick && post.lastModified | formatTimestampFromAgo}}
                                        </time>
                                    </div>
                                </template>
                            </template>
                        </div>
                        <div class="body" on-marked-js-highlight="{{hilight}}">
                            <template if="{{ !post.deleted && !isCollapsed }}">
                                <marked-element
                                    text="{{previewing ? ( previewText ? previewText : '' ) : post.text}}">
                                </marked-element>
                            </template>
                            <template if="{{ post.deleted}}">
                                <div class="deleted-post-body">
                                    <em>[deleted]</em>
                                </div>
                            </template>
                        </div>
                        <template if="{{!previewing}}">
                            <speakur-post-footer
                                id="postFooter"
                                class="footer"
                                postVotes="{{postVotes}}"
                                voteElem="{{$.vote}}"
                                post="{{post}}"></speakur-post-footer>
                        </template>
                    </speakur-card>
                </div>
            </div>

            <!--
              -- container for reply composition and all replies to this post.
              -- visual indentation is controlled by the level
              -->

            <core-collapse opened id="extraCollapse">
                <div _style="margin-left: {{level+1 * indentWidth}}px;">

                    <template if="{{ canEditPost(post, globals.profile, globals.isAdmin) }}">
                        <speakur-compose
                            id="editCompose"
                            threadId="{{threadId}}"
                            replyTo="{{ editReplyTo }}"
                            editing="{{ editId }}"
                            hidden?="{{!showingEdit}}"
                            firebaseLocation="{{firebaseLocation}}">
                        </speakur-compose>
                    </template>

                    <speakur-compose
                        id="replyCompose"
                        threadId="{{threadId}}"
                        replyTo="{{postId}}"
                        hidden?="{{!showingReply}}"
                        firebaseLocation="{{firebaseLocation}}">
                    </speakur-compose>

                    <speakur-post-set
                        id="replySet"
                        firebaseLocation="{{firebaseLocation}}"
                        sortOrder="{{sortOrder}}"
                        level="{{level + 1}}"
                        parentId="{{postId}}"
                        threadId="{{threadId}}"
                        ></speakur-post-set>

                </div>
            </core-collapse>
        </template>
    </template>
    <script>
        Polymer({
            indentWidth: 54,
            threadId: null,
            parentId: null,
            postId: null,
            previewing: false,
            previewText: null,
            editId: null,
            showingEdit: false,
            showingReply: false,
            isCollapsed: false,

//            observe: {
//                'previewText': 'previewTextChanged'
//            },
//
//            previewTextChanged: function () {
//                console.log('preview changed:', this.previewText);
//            },

            numRepliesToMe: function () {
                var numReplies = 0;
                if (this.$.replySet.posts && this.$.replySet.postIds) {
                    numReplies = this.$.replySet.postIds.length;
                }
                return numReplies;
            },

            /**
             * Delete a post
             */
            deletePost: function (e, detail, sender) {
                // Need to stop the event b/c we're only deleting this, not all parent posts!
                e.stopPropagation();

                this.log("Requesting delete post: ", detail);

                var numReplies = this.numRepliesToMe();

                var deleted_by_uid = null;
                if (this.globals.profile) {
                    deleted_by_uid = this.globals.profile.uid;
                }

                if (numReplies > 0) {
                    this.log("Post has ", numReplies, " direct replies.");
                    // Just mark it as deleted and clear its text and author.
                    // This will allow replies under it to persist.
                    // In the future we might allow recursive deleting under some circumstances.
                    this.post.deleted = true;
                    this.post.delete_time = new Date().getTime();
                    this.post.deleted_by = deleted_by_uid;
                    this.post.text = '';
                    this.post.author = {
                        uid: '_del'
                    };
                } else {
                    this.log("Post has no replies; deleting.");
                    var post_copy = _.clone(this.post);
                    this.$.postDB.remove("/");

                    // TODO: check if parent has no more replies and is marked deleted,
                    // then actually delete it!
                    this.fire('post-deleted', post_copy);

                }
                this.toast("Post deleted.");

            },

            /*
                        safeTags: function(value) {
                            if (!value) { return value; }
                            this.log("Foo", value);
                            return strip_tags(value, null);
                        }
            */

            ready: function () {
            },

            hilight: function (event, detail, sender) {
                detail.code = hljs.highlightAuto(detail.code).value;
            },

            replyToPost: function (e) {
                // this.fire('not-yet-implemented');
                this.showingReply = !this.showingReply;

                // Need to stop the event b/c we're only replying to this, not all parent posts.
                e.stopPropagation();
            },

            submittedReply: function (e) {
                this.log("reply submitted: ", e.detail);
                // Close reply window?
                this.showingReply = false;
                e.stopPropagation();
            },

            canceledReply: function (e) {
                this.log("reply canceled.");
                this.showingReply = false;
                e.stopPropagation();
            },

            canEditPost: function (post, profile, isAdmin) {
                if (!this.$ || !this.$.postFooter) {
                    return false;
                }
                if (!post || !profile) {
                    return false;
                }
                return this.$.postFooter.canEditPost(post, profile, isAdmin);
            },


            editPost: function (e) {
                this.showingEdit = !this.showingEdit;
                this.editId = this.postId;

                if (this.post.replyTo) {
                    this.editReplyTo = this.post.replyTo;
                } else {
                    this.editReplyTo = this.post.threadId;
                }

                // Need to stop the event b/c we're only editing this, not all parent posts.
                e.stopPropagation();
            },

            submittedEdit: function (e) {
                this.log("edit submitted: ", e.detail);
                // Close reply window?
                this.showingEdit = false;
                e.stopPropagation();
            },

            canceledEdit: function (e) {
                this.log("Edit Post canceled.");
                this.showingEdit = false;
                e.stopPropagation();
            },


            reportPost: function (e) {
                this.fire('not-yet-implemented');
                e.stopPropagation();

            },

            voteUp: function (e) {
                // this.fire('not-yet-implemented');
                this.$.vote.voteUp();
                e.stopPropagation();

            },

            voteDown: function (e) {
                // this.fire('not-yet-implemented');
                this.$.vote.voteDown();
                e.stopPropagation();
            },

            childPostDeleted: function (e, detail, sender) {
                // a post under me was deleted by the current user.
                // See if we should delete this post - only
                // if it's marked for deletion already and has no other replies.

                if (this.postId == detail.replyTo) {
                    this.log("Me: ", this.postId, " child post deleted: ", detail);

                    // am I marked deleted?
                    if (this.post.deleted) {
                        var numReplies = this.numRepliesToMe();
                        // a reply to me was deleted, and I'm marked-deleted w/ no children!
                        if (numReplies == 0) {
                            this.log("I should be deleted right now b/c my only child was deleted! ", this.post);
                            this.fire('delete-post');
                        } else {
                            this.log('Not sweeping deleted post bc has active ', numReplies, ' children');
                        }
                    } else {
                        this.log("Stopping deleted post sweep at non-deleted post.");
                    }
                    e.stopPropagation();
                }

            },

            postCollapseToggle: function (e, details, sender) {
                // this.log("post collapsed", this.post, details, sender);
                this.isCollapsed = !this.isCollapsed;
                this.$.imgCollapse.toggle();
                this.$.extraCollapse.toggle();
                e.stopPropagation();
            },

            // Net votes text displayed in post header.
            getNetVotesText: function (postVotes, votedUp, votedDown) {
                if (!postVotes) return '';

//                var downVotes = this.$.vote.postVotesDown;
//                var upVotes = this.$.vote.postVotesUp;
                var downVotes = postVotes.down || 0;
                var upVotes = postVotes.up || 0;

                if (upVotes === 0 && downVotes === 0) return '';

                var netVotes = upVotes - downVotes;
                if (netVotes > -1) {
                    return '(+' + netVotes + ')';
                } else {
                    return '(-' + netVotes + ')';
                }

            },

            eventDelegates: {
                'reply-to-post': 'replyToPost',
                'edit-post': 'editPost',
                'cancel-edit': 'canceledEdit',
                'submitted-edit': 'submittedEdit',
                'report-post': 'reportPost',
                'delete-post': 'deletePost',
                'vote-up': 'voteUp',
                'vote-down': 'voteDown',
                'cancel-post': 'canceledReply',
                'submitted-post': 'submittedReply',
                'speakur-card-toggle': 'postCollapseToggle',
                'post-deleted': 'childPostDeleted'
            },

            computed: {
                'netVotesText': 'getNetVotesText(postVotes, $.vote.votedUp, $.vote.votedDown)'
            }

        });
    </script>
</polymer-element>
