<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../firebase-element/firebase-element.html">
<link rel="import" href="../../marked-element/marked-element.html">
<link rel="import" href="../../highlightjs-element/highlightjs-element.html">
<link rel="import" href="../../pvc-globals/pvc-globals.html">

<link rel="import" href="speakur-author-img.html">
<link rel="import" href="speakur-author-slug.html">
<link rel="import" href="speakur-card.html">
<link rel="import" href="speakur-post-footer.html">
<link rel="import" href="speakur-post-set.html">
<link rel="import" href="speakur-compose.html">

<polymer-element
    name="speakur-post"
    attributes="firebaseLocation threadId parentId postId previewing previewText level">
    <template>
        <link rel="stylesheet" href="../../highlightjs/styles/default.css">
        <style>
            /* give less padding to the body of the card within. maybe just change the card itself */
            speakur-card /deep/ .card-body {
                padding-top: 0;
                padding-bottom: 0;
            }
            .post-author-img {
                padding: 10px 10px 10px 0px;
            }

            speakur-card > .header /deep/ .username {
                margin-right: 12px;
                font-weight: bold;
                text-shadow: 1px 1px rgba(20, 20, 22, 0.78);
            }

        </style>
        <pvc-globals namespace="speakur-discussion" values="{{globals}}"></pvc-globals>
        <template if="{{!previewing}}">
            <firebase-element
                id="base" data="{{post}}"
                location="{{postLocation(firebaseLocation, parentId, postId) }}"></firebase-element>

        </template>
        <template if="{{!previewing || previewText}}">
            <div layout horizontal>
                <div class="post-author-img">
                    <speakur-author-img
                        width="32" height="32"
                        author="{{previewing ? globals.profile : post.author}}">
                    </speakur-author-img>
                </div>
                <div flex>
                    <speakur-card>
                        <div layout horizontal center class="header">
                            <template if="{{previewing}}">
                                Preview
                            </template>
                            <template if="{{!previewing}}">
                                <!--
                                                        <paper-button
                                                                id="deletebutton"
                                                                on-click="{{deletePost}}"
                                                                >
                                                            <paper-icon-button
                                                                    style="color: red; width: 12px; height: 12px;"
                                                                    icon="delete"></paper-icon-button>
                                                            Delete
                                                        </paper-button>
                                -->
                                <speakur-author-slug showPicture="false" author="{{post.author}}"></speakur-author-slug>
                                <em title="{{post.timestamp | formatTimestamp}}">
                                    <small>{{globals.updateTick && post.timestamp | formatTimestampFromAgo}}</small>
                                </em>
                            </template>
                        </div>
                        <div class="body" on-marked-js-highlight="{{hilight}}">
                            <!--
                                            {{post.text | stripTags }}
                            -->
                            <!--
                                            <mark-down text="{{post.text}}">
                                            </mark-down>
                            -->
                            <marked-element
                                text="{{previewing ? ( previewText ? previewText : '' ) : post.text}}">
                            </marked-element>
                        </div>
                        <template if="{{!previewing}}">
                            <speakur-post-footer class="footer" post="{{post}}"></speakur-post-footer>
                        </template>
                    </speakur-card>

                </div>
            </div>

            <!--
              -- container for reply composition and all replies to this post.
              -- visual indentation is controlled by the level
              -->
            <div style="margin-left: {{level+1 * 45}}px;">
                <speakur-compose
                    id="replyCompose"
                    threadId="{{threadId}}"
                    replyTo="{{postId}}"
                    hidden?="{{!showingReply}}"
                    firebaseLocation="{{firebaseLocation}}">
                </speakur-compose>

                <speakur-post-set
                    firebaseLocation="{{firebaseLocation}}"
                    level="{{level + 1}}"
                    parentId="{{postId}}"
                    threadId="{{threadId}}"
                    ></speakur-post-set>

            </div>
        </template>
    </template>
    <script>
        Polymer({
            previewing: false,
            previewText: null,
            showingReply: false,

            postLocation: function (firebaseLocation, parentId, postId) {
                // {{firebaseLocation}}/posts/{{parentId}}/{{postId}}
                if (!firebaseLocation) { return ''; }
                if (!parentId) { return ''; }
                if (!postId) { return ''; }
                return firebaseLocation + "/posts/" + parentId + "/" + postId;
            },

            deletePost: function (event, detail, sender) {
                console.log("Deleting post: ", this.postId, this.post);
                this.$.base.remove("/");
            },
            /*
                        safeTags: function(value) {
                            if (!value) { return value; }
                            console.log("Foo", value);
                            return strip_tags(value, null);
                        }
            */

            ready: function () {
            },

            hilight: function (event, detail, sender) {
                detail.code = hljs.highlightAuto(detail.code).value;
            },

            replyToPost: function() {
                // this.fire('not-yet-implemented');
                this.showingReply = true;
            },

            submittedReply: function (e) {
                console.log("reply submitted: ", e.detail);
                // Close reply window?
                this.showingReply = false;
            },

            canceledReply: function () {
                console.log("reply canceled.");
                this.showingReply = false;
            },

            editPost: function() {
                this.fire('not-yet-implemented');
            },

            reportPost: function() {
                this.fire('not-yet-implemented');
            },

            voteUp: function () {
                this.fire('not-yet-implemented');
            },

            voteDown: function () {
                this.fire('not-yet-implemented');
            },

            eventDelegates: {
                'reply-to-post': 'replyToPost',
                'edit-post': 'editPost',
                'report-post': 'reportPost',
                'delete-post': 'deletePost',
                'vote-up': 'voteUp',
                'vote-down': 'voteDown',
                'cancel-post': 'canceledReply',
                'submitted-post': 'submittedReply'
            }

        });
    </script>
</polymer-element>
