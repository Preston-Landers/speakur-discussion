<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../firebase-element/firebase-element.html">
<link rel="import" href="../../marked-element/marked-element.html">
<link rel="import" href="../../highlightjs-element/highlightjs-element.html">
<link rel="import" href="../../pvc-globals/pvc-globals.html">

<link rel="import" href="speakur-author-slug.html">
<link rel="import" href="speakur-card.html">

<polymer-element name="speakur-post" attributes="firebaseLocation threadId postId previewMode previewText">
    <template>
        <link rel="stylesheet" href="../../highlightjs/styles/default.css">
        <style>
        </style>
        <pvc-globals namespace="speakur-discussion" values="{{globals}}"></pvc-globals>
        <template if="{{!previewMode}}">
            <firebase-element
                    id="base" data="{{post}}"
                    location="{{firebaseLocation}}/posts/{{threadId}}/{{postId}}"></firebase-element>

        </template>
        <template if="{{!previewMode || (previewMode && previewText)}}">
            <speakur-card>
                <div layout horizontal center class="header">
                    <template if="{{previewMode}}">
                        Preview
                    </template>
                    <template if="{{!previewMode}}">
<!--
                        <paper-button
                                id="deletebutton"
                                on-click="{{deletePost}}"
                                >
                            <paper-icon-button
                                    style="color: red; width: 12px; height: 12px;"
                                    icon="delete"></paper-icon-button>
                            Delete
                        </paper-button>
-->
                        <template if="{{canDeletePost}}">
                            <a on-click="{{deletePost}}"
                               title="Delete this post permanently"
                               href="#">
                                <core-icon
                                    icon="delete"
                                    style="color: red; width: 12px; height: 12px; margin-bottom:4px;">
                                </core-icon>Delete</a>
                        </template>
                        <speakur-author-slug author="{{post.author}}"></speakur-author-slug>
                        <em>
                            <small>{{post.timestamp | formatTimestamp}}</small>
                        </em>
                    </template>
                </div>
                <div class="body" on-marked-js-highlight="{{hilight}}">
                    <!--
                                    {{post.text | stripTags }}
                    -->
                    <!--
                                    <mark-down text="{{post.text}}">
                                    </mark-down>
                    -->
                    <marked-element
                            text="{{previewMode ? ( previewText ? previewText : '' ) : post.text}}">
                    </marked-element>
                </div>
            </speakur-card>
        </template>
    </template>
    <script>
        Polymer({
            previewMode: false,
            previewText: null,

            deletePost: function (event, detail, sender) {
                console.log("Deleting post: ", this.postId, this.post);
                this.$.base.remove("/");
            },
            /*
                        safeTags: function(value) {
                            if (!value) { return value; }
                            console.log("Foo", value);
                            return strip_tags(value, null);
                        }
            */

            ready: function () {
            },

            hilight: function (event, detail, sender) {
                detail.code = hljs.highlightAuto(detail.code).value;
            },

            canDeletePost: function() {
                if (this.post.author.uid === "anonymous" ||
                    this.post.author.uid === "anon") {
                    // Temporary - anyone can delete anon posts
                    return true;
                }
                return this.post.author.uid === this.globals.profile.uid;
            }
        });
    </script>
</polymer-element>
