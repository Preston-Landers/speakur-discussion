<!--
    @license
    Copyright (c) 2015 Preston Landers <planders@utexas.edu>. All rights reserved.
    Additional portions Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-scaffold/core-scaffold.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../font-roboto/roboto.html">

<!-- NOTE: the presence of this plugin on the page with Firefox + Ad Block Plus plugin
     will cause the entire page to not load.-->
<link rel="import" href="../core-icons/social-icons.html">

<link rel="import" href="../firebase-element/firebase-element.html">
<link rel="import" href="../firebase-element/firebase-login.html">

<link rel="import" href="elements/speakur-toolbar.html">
<link rel="import" href="elements/speakur-compose.html">
<link rel="import" href="elements/speakur-thread-view.html">

<!--
This is a Web Component-based custom HTML element that provides a
user friendly discussion forum for any web resource without requiring
a dedicated server.

##### Example

    <speakur-discussion
        xtitle="12 Crazy Tricks That Cable Companies Hate!"
        theme="dark"
        moderator="example_moderator_1">
    </speakur-discussion>

##### Requirements

To embed a Speakur discussion within a web page, you must do three things:

1) Enable W3C Web Components via the Polymer script webcomponents.js

    <script src="bower_components/webcomponentsjs/webcomponents.js"></script>

2) Use HTML Imports to bring in the `<speakur-discussion>` element

    <link rel="import" href="bower_components/speakur-discussion/speakur-discussion.html">

3) Place the `<speakur-discussion>` element somewhere in the page as shown above.

TODO: link to detailed instructions on using bower_components

@element speakur-discussion
@blurb Provides an embeddable real-time discussion forum for a web resource.
@status alpha
@homepage https://github.com/Preston-Landers/speakur-discussion
-->
<polymer-element name="speakur-discussion" attributes="theme href moderators xtitle firebaseLocation">

    <template>
        <!-- Congratulations, you have found the secret message. -->

        <link rel="stylesheet" href="speakur-discussion.css"/>
        <link id="speakur-theme" rel="stylesheet" href="speakur-theme-default.css"/>

        <firebase-login id="baseLogin" user="{{user}}" statusKnown="{{statusKnown}}" location="{{firebaseLocation}}"
                        provider="google" on-login="{{onLogin}}" on-error="{{onLoginError}}"></firebase-login>
        <firebase-element
                id="dbThread" location="{{firebaseLocation + '/threads/' + threadId }}"
                data="{{thread}}"></firebase-element>

        <paper-toast text="This feature is not implemented yet." id="nyi-toast"></paper-toast>

        <div class="speakur-container {{ closed ? 'closed' : '' }}">

            <template if="{{closed}}">
                <speakur-toolbar class="speakur-closed-bar">
                    <paper-icon-button icon="speaker-notes" on-click="{{toggle}}">
                    </paper-icon-button>
                    <paper-button flex on-click="{{toggle}}" class="speakur-toggle-button">
                        View Comments ({{numComments}})
                    </paper-button>
                    <paper-icon-button id="closedprofilebutton"
                                       icon="social:person"></paper-icon-button>
                </speakur-toolbar>


            </template>
            <template if="{{!closed}}">
                <div vertical layout class="speakur-open-layout">
                    <speakur-toolbar class="speakur-header-bar">
                        <paper-icon-button
                                title="Hide"
                                icon="remove-circle"
                                on-click="{{toggle}}" class="speakur-toggle-button speakur-close-button">
                        </paper-icon-button>
                        <div flex class="speakur-header-titlebox">
                            {{xtitle}}
                        </div>
                        <paper-icon-button id="searchbutton"
                                           on-click="{{search}}"
                                           icon="search"></paper-icon-button>
                        <paper-icon-button id="profilebutton"
                                           on-click="{{login}}"
                                           icon="social:person"></paper-icon-button>
                        <paper-icon-button id="menubutton"
                                           on-click="{{menu}}"
                                           icon="menu"></paper-icon-button>
                    </speakur-toolbar>


                    <div class="speakur-body-container">
                        <speakur-compose
                                threadId="{{threadId}}"
                                firebaseLocation="{{firebaseLocation}}">
                        </speakur-compose>
                        <speakur-thread-view
                                threadId="{{threadId}}"
                                firebaseLocation="{{firebaseLocation}}">
                        </speakur-thread-view>
                    </div>

                    <speakur-toolbar class="speakur-footer-bar">
                        <div flex style="margin-left: 8px;">
                            <!--Questionable where we want to put this, if anywhere.-->
                            <content></content>

                        </div>
                        <div class="speakur-copyright">
                            <small>
                                Copyright &copy; 2015 Preston Landers
                            </small>
                        </div>
                        <paper-icon-button
                                id="reportbutton"
                                on-click="{{reportProblem}}"
                                title="Report a problem."
                                icon="report-problem">
                        </paper-icon-button>
                    </speakur-toolbar>
                </div>

            </template>

        </div>

    </template>

    <!-- Is this style import OK? TODO: come back to this and make a proper import wrapper -->
    <script src="../js-md5/js/md5.min.js"></script>

    <script>

        Polymer({
            /**
             * The `xtitle` attribute determines the title of the discussion. Defaults to the containing
             * page's title.
             *
             * Note that I can't name this title due to it being a built in HTML attribute apparently...?
             *
             * @attribute xtitle
             * @type string
             * @default window.document.title
             */
            xtitle: window.document.title,

            /**
             * The `href` attribute determines the "target" of the discussion. Defaults to the containing page's location.
             * Changing the `href` will automatically switch the view to a different discussion thread.
             *
             * `href` is a very important concept for `Speakur-discussion`. It is the official unique name of the
             * discussion. It defaults to the window location URL, but this is *not* necessarily the correct value.
             * For instance, your site may have many different views (at different URLs) of an abstract data object
             * like a 'Project' that has a canonical URL. If you want to attach the discussion to the 'Project'
             * no matter what its current view, then set the href to the canonical URL of the project, such as:
             * `site.example.com/projects/HappyFunProject`
             *
             * Note that a protocol such as http:// is not required and will be automatically removed. You should
             * include your domain name if using a public/default firebaseLocation. The href is normalized and turned
             * into a threadId by the following rules:
             *   * lowercased
             *   * protocol is removed, if any  (such as http:// or https://)
             *   * port is NOT removed, nor are query parameters
             *   * md5 hash is used as threadId
             *
             * @attribute href
             * @type string
             * @default window.location.href
             */
            href: window.location.href,

            /**
             * The `theme` attribute determines the style or look and feel of the discussion box.
             * Available themes are: default (TODO)
             *
             * @attribute theme
             * @type string
             * @default 'default' (a default theme)
             */
            theme: 'default',

            /**
             * The `moderators` attribute determines the users who are allowed to moderate this forum. The users are
             * represented as Firebase User IDs, comma separated.
             *
             * (TODO: non functional!)
             *
             * @attribute moderators
             * @type string
             * @default (None)
             */
            moderators: '',

            /**
             * The `firebaseLocation` attribute determines the source database URL for the comments. A default
             * database will be used if none is provided.  If using the public (default) Speakur firebase then
             * you must incorporate your domain name in the {@link href} field.
             *
             * @attribute firebaseLocation
             * @type string
             * @default (a suitable default is provided)
             */
            firebaseLocation: 'https://speakur.firebaseio.com',

            /**
             * numComments is the number of comments currently available at this location.
             *
             * @property numComments
             * @type int
             * @default number of comments at this location
             */
            numComments: 0,

            /**
             * the threadId this discussion is participating in. This is automatically derived from {@link href}
             * and should not be set directly.
             *
             * @property threadId
             * @type string
             * @default ID of this discussion (based on href)
             */
            threadId: null,

            /**
             * This is true when the discussion widget is closed (collapsed).
             *
             * @property closed
             * @type boolean
             * @default true if the discussion is in the closed (collapsed) state
             */
            closed: true,

            thread: null,

            ready: function () {
                // Ready is a lifecycle callback.
                // You can do setup work in here.
                // More info: http://www.polymer-project.org/docs/polymer/polymer.html#lifecyclemethods
                // this.title = 'ok?';
                this.setThreadIdFromHref();
            },

            /**
             * The `sayHello` method will return a greeting.
             *
             * @method sayHello
             * @param {String} greeting Pass in a specific greeting.
             * @return {String} Returns a string greeting.
             */
            sayHello: function (greeting) {
                var response = greeting || 'Hello World!';
                return 'speakur-discussion says, ' + response;
            },

            /**
             * The `speakur-discussion-lasers-success` event is fired whenever we
             * call fireLasers.
             *
             * @event speakur-discussion-lasers-success
             * @param {Object} detail
             *   @param {string} detail.sound An amazing sound.
             */

            /**
             * The `fireLasers` method will fire the lasers. At least
             * it will dispatch an event that claims lasers were fired :)
             *
             * @method fireLasers
             */
            fireLasers: function () {
                this.fire('speakur-discussion-lasers-success', {sound: 'Pew pew pew!'});
            },

            toggle: function () {
                this.closed = !this.closed;
                // console.log("Speakur discussion toggled.");
            },

            search: function () {
                console.log("Search clicked.");
                this.$['nyi-toast'].show();
            },

            menu: function () {
                console.log("Menu clicked.");
                this.$['nyi-toast'].show();
            },

            reportProblem: function () {
                console.log("Report Problem clicked.");
                this.$['nyi-toast'].show();
            },

            login: function () {
                console.log("Login clicked.");
                this.$['nyi-toast'].show();
            },

            logout: function () {
                console.log("Logout clicked.");
                this.$['nyi-toast'].show();
            },

            setThreadIdFromHref: function () {
                // Normalize: everything to lower case
                var href = this.href.toLowerCase();
                // normalize: remove protocol.
                href = href.replace(/^.*?:\/\//, "");

                // Other possible normalizations:
                // Remove port?
                // Enforce domain name requirement?
                // Remove query params?
                // once we do this it's hard to undo as any changes to normalization will orphan threads

                // digest it
                var threadId = md5(href);
                console.log("href " + href + " -> md5: " + threadId);
                // set it.
                this.threadId = threadId;
            },

            hrefChanged: function () {
                this.setThreadIdFromHref();
            },

            threadIdChanged: function (oldValue, newValue) {
                console.log("Thread ID was changed from " + oldValue + " to ->" + newValue);
            },

            threadChanged: function () {
                console.log("Thread changed. ", this.$.dbThread.location, " thread ID: ", this.threadId);
                if (this.threadId && !this.thread) {
                    // Create a default thread description.
                    var new_thread = {
                        href: this.href,
                        threadId: this.threadId,
                        title: this.xtitle,
                        created: new Date().getTime(),
                        text: null,
                        theme: this.theme,
                        moderators: this.moderators,

                        // TODO: fix owners!
                        owner: {
                            uid: 'anonymous',
                            username: 'Anonymous'
                        }
                    };
                    this.thread = new_thread;
                    console.log("Created new thread for " + this.href + " -> " + this.thread);
                } else {
                    console.log("this.thread -> ", this.thread);
                }

            },

            observe: {
                '$.dbThread.location': 'fbLocationChanged',
                thread: 'threadChanged'
            }

        });

    </script>

</polymer-element>
